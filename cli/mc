#!/usr/bin/env node

// Mission Control CLI for agents
// Usage: mc <command> [options]

const { createClient } = require('@supabase/supabase-js')
require('dotenv').config({ path: require('path').join(__dirname, '../app/.env.local') })

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SECRET_KEY || process.env.SUPABASE_SERVICE_ROLE_KEY
)

const commands = {
  async heartbeat({ agent }) {
    const { error } = await supabase
      .from('mc_agents')
      .update({ 
        last_heartbeat: new Date().toISOString(),
        updated_at: new Date().toISOString()
      })
      .eq('name', agent)
    
    if (error) throw error
    
    await logActivity(agent, 'heartbeat', `${agent} heartbeat`)
    console.log(`✓ Heartbeat recorded for ${agent}`)
  },

  async status({ agent, status, task }) {
    const updates = { 
      status,
      updated_at: new Date().toISOString()
    }

    if (task) {
      const { data: taskData } = await supabase
        .from('mc_tasks')
        .select('id')
        .eq('title', task)
        .single()
      
      if (taskData) {
        updates.current_task_id = taskData.id
      }
    }

    const { error } = await supabase
      .from('mc_agents')
      .update(updates)
      .eq('name', agent)
    
    if (error) throw error
    
    await logActivity(agent, 'status_change', `${agent} status changed to ${status}`)
    console.log(`✓ Status updated: ${agent} → ${status}`)
  },

  async task({ action, title, description, assign, status, tags }) {
    if (action === 'create') {
      const assignedAgentIds = []
      if (assign) {
        const agentNames = assign.split(',')
        for (const name of agentNames) {
          const { data } = await supabase
            .from('mc_agents')
            .select('id')
            .eq('name', name.trim())
            .single()
          if (data) assignedAgentIds.push(data.id)
        }
      }

      const { data, error } = await supabase
        .from('mc_tasks')
        .insert({
          title,
          description,
          assigned_agent_ids: assignedAgentIds,
          status: assignedAgentIds.length > 0 ? 'assigned' : 'inbox',
          tags: tags ? tags.split(',').map(t => t.trim()) : []
        })
        .select()
        .single()
      
      if (error) throw error
      
      await logActivity(null, 'task_created', `Task created: ${title}`, data.id)
      console.log(`✓ Task created: ${data.id}`)
      console.log(`  Title: ${title}`)
      if (assignedAgentIds.length > 0) {
        console.log(`  Assigned to: ${assign}`)
      }
    }
  },

  async comment({ task, agent, message }) {
    // Find task by title or ID
    const { data: taskData } = await supabase
      .from('mc_tasks')
      .select('id')
      .or(`title.eq.${task},id.eq.${task}`)
      .single()
    
    if (!taskData) {
      console.error(`Task not found: ${task}`)
      process.exit(1)
    }

    // Find agent
    const { data: agentData } = await supabase
      .from('mc_agents')
      .select('id')
      .eq('name', agent)
      .single()
    
    if (!agentData) {
      console.error(`Agent not found: ${agent}`)
      process.exit(1)
    }

    const { error } = await supabase
      .from('mc_comments')
      .insert({
        task_id: taskData.id,
        agent_id: agentData.id,
        content: message
      })
    
    if (error) throw error
    
    await logActivity(agent, 'comment', message, taskData.id)
    console.log(`✓ Comment posted to task: ${task}`)
  },

  async list({ type = 'tasks' }) {
    if (type === 'tasks') {
      const { data, error } = await supabase
        .from('mc_tasks')
        .select('*')
        .neq('status', 'done')
        .order('created_at', { ascending: false })
      
      if (error) throw error
      
      console.log('\nACTIVE TASKS:\n')
      data.forEach(task => {
        console.log(`[${task.status.toUpperCase()}] ${task.title}`)
        console.log(`  ID: ${task.id}`)
        if (task.description) console.log(`  ${task.description}`)
        console.log()
      })
    } else if (type === 'agents') {
      const { data, error } = await supabase
        .from('mc_agents')
        .select('*')
        .order('name')
      
      if (error) throw error
      
      console.log('\nAGENTS:\n')
      data.forEach(agent => {
        console.log(`${agent.emoji} ${agent.name} [${agent.status.toUpperCase()}]`)
        console.log(`  ${agent.role}`)
        if (agent.last_heartbeat) {
          const mins = Math.floor((Date.now() - new Date(agent.last_heartbeat).getTime()) / 60000)
          console.log(`  Last heartbeat: ${mins}m ago`)
        }
        console.log()
      })
    }
  }
}

async function logActivity(agentName, type, message, taskId = null) {
  let agentId = null
  if (agentName) {
    const { data } = await supabase
      .from('mc_agents')
      .select('id')
      .eq('name', agentName)
      .single()
    agentId = data?.id
  }

  await supabase
    .from('mc_activities')
    .insert({
      agent_id: agentId,
      type,
      message,
      task_id: taskId
    })
}

// Parse command line arguments
const args = process.argv.slice(2)
const command = args[0]

if (!command || !commands[command]) {
  console.log(`
Mission Control CLI

Usage:
  mc heartbeat --agent <name>
  mc status --agent <name> --status <idle|active|blocked> [--task <title>]
  mc task create --title <title> [--description <desc>] [--assign <agent>] [--tags <tag1,tag2>]
  mc comment --task <title|id> --agent <name> --message <text>
  mc list [--type <tasks|agents>]

Examples:
  mc heartbeat --agent Clyde
  mc status --agent Clyde --status active --task "Building Mission Control"
  mc task create --title "Fix Bonnie heartbeat" --assign Bonnie --tags bug,urgent
  mc comment --task "Fix Bonnie heartbeat" --agent Clyde --message "Looking into it"
  mc list --type tasks
`)
  process.exit(1)
}

// Parse options
const options = {}
for (let i = 1; i < args.length; i += 2) {
  const key = args[i].replace(/^--/, '')
  const value = args[i + 1]
  options[key] = value
}

// Execute command
commands[command](options)
  .catch(err => {
    console.error('Error:', err.message)
    process.exit(1)
  })
