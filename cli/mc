#!/usr/bin/env node

// Command CLI for agents
// Usage: mc <command> [options]

const { createClient } = require('@supabase/supabase-js')
require('dotenv').config({ path: require('path').join(__dirname, '../app/.env.local') })
const { encrypt, decrypt } = require('./crypto')

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SECRET_KEY || process.env.SUPABASE_SERVICE_ROLE_KEY
)

const commands = {
  async heartbeat({ agent }) {
    const { error } = await supabase
      .from('mc_agents')
      .update({ 
        last_heartbeat: new Date().toISOString(),
        updated_at: new Date().toISOString()
      })
      .eq('name', agent)
    
    if (error) throw error
    
    await logActivity(agent, 'heartbeat', `${agent} heartbeat`)
    console.log(`âœ“ Heartbeat recorded for ${agent}`)
  },

  async status({ agent, status, task }) {
    const updates = { 
      status,
      updated_at: new Date().toISOString()
    }

    if (task) {
      const { data: taskData } = await supabase
        .from('mc_tasks')
        .select('id')
        .eq('title', task)
        .single()
      
      if (taskData) {
        updates.current_task_id = taskData.id
      }
    }

    const { error } = await supabase
      .from('mc_agents')
      .update(updates)
      .eq('name', agent)
    
    if (error) throw error
    
    await logActivity(agent, 'status_change', `${agent} status changed to ${status}`)
    console.log(`âœ“ Status updated: ${agent} â†’ ${status}`)
  },

  async task({ action, title, description, assign, status, tags, id }) {
    if (action === 'create') {
      const assignedAgentIds = []
      if (assign) {
        const agentNames = assign.split(',')
        for (const name of agentNames) {
          const { data } = await supabase
            .from('mc_agents')
            .select('id')
            .eq('name', name.trim())
            .single()
          if (data) assignedAgentIds.push(data.id)
        }
      }

      // Default to Jay's account for CLI-created tasks
      // TODO: Make this configurable or detect from environment
      const defaultAccountId = process.env.MC_ACCOUNT_ID || '99741f28-95aa-4e33-b29c-5bf046a4ba55'
      
      // Encrypt sensitive fields before storing
      const { data, error } = await supabase
        .from('mc_tasks')
        .insert({
          title: encrypt(title),
          description: description ? encrypt(description) : null,
          assigned_agent_ids: assignedAgentIds,
          status: assignedAgentIds.length > 0 ? 'assigned' : 'inbox',
          tags: tags ? tags.split(',').map(t => t.trim()) : [],
          account_id: defaultAccountId
        })
        .select()
        .single()
      
      if (error) throw error
      
      await logActivity(null, 'task_created', encrypt(`Task created: ${title}`), data.id)
      console.log(`âœ“ Task created: ${data.id}`)
      console.log(`  Title: ${title}`)
      if (assignedAgentIds.length > 0) {
        console.log(`  Assigned to: ${assign}`)
      }
    } else if (action === 'update') {
      if (!id) {
        console.error('Task ID required for update')
        process.exit(1)
      }
      
      const updates = { updated_at: new Date().toISOString() }
      
      if (status) updates.status = status
      if (title) updates.title = encrypt(title)
      if (description) updates.description = encrypt(description)
      if (tags) updates.tags = tags.split(',').map(t => t.trim())
      
      if (assign) {
        const assignedAgentIds = []
        const agentNames = assign.split(',')
        for (const name of agentNames) {
          const { data } = await supabase
            .from('mc_agents')
            .select('id')
            .eq('name', name.trim())
            .single()
          if (data) assignedAgentIds.push(data.id)
        }
        updates.assigned_agent_ids = assignedAgentIds
      }
      
      const { data, error } = await supabase
        .from('mc_tasks')
        .update(updates)
        .eq('id', id)
        .select()
        .single()
      
      if (error) throw error
      
      const decryptedTitle = decrypt(data.title)
      await logActivity(null, 'task_updated', encrypt(`Task updated: ${decryptedTitle}`), id)
      console.log(`âœ“ Task updated: ${decryptedTitle}`)
      if (status) console.log(`  Status: ${status}`)
    }
  },

  async comment({ task, agent, message }) {
    // Find task by title or ID
    const { data: taskData } = await supabase
      .from('mc_tasks')
      .select('id')
      .or(`title.eq.${task},id.eq.${task}`)
      .single()
    
    if (!taskData) {
      console.error(`Task not found: ${task}`)
      process.exit(1)
    }

    // Find agent
    const { data: agentData } = await supabase
      .from('mc_agents')
      .select('id')
      .eq('name', agent)
      .single()
    
    if (!agentData) {
      console.error(`Agent not found: ${agent}`)
      process.exit(1)
    }

    // Encrypt content before storing
    const { error } = await supabase
      .from('mc_comments')
      .insert({
        task_id: taskData.id,
        agent_id: agentData.id,
        content: encrypt(message)
      })
    
    if (error) throw error
    
    await logActivity(agent, 'comment', encrypt(message), taskData.id)
    console.log(`âœ“ Comment posted to task: ${task}`)
  },

  async check({ agent = 'Bonnie' }) {
    const fs = require('fs')
    const STATE_FILE = '/home/umbrel/.openclaw/workspace/memory/heartbeat-state.json'
    
    // Load state
    let state = { lastMCCommentsCheck: null }
    try {
      state = JSON.parse(fs.readFileSync(STATE_FILE, 'utf8'))
    } catch {}
    
    const lastCheck = state.lastMCCommentsCheck || new Date(0).toISOString()
    const now = new Date().toISOString()
    
    // Get agent ID
    const { data: agentData } = await supabase
      .from('mc_agents')
      .select('id')
      .eq('name', agent)
      .single()
    
    if (!agentData) {
      console.error(`Agent not found: ${agent}`)
      process.exit(1)
    }
    
    // Get tasks assigned to agent
    const { data: tasks } = await supabase
      .from('mc_tasks')
      .select('id, title, status, created_at')
      .contains('assigned_agent_ids', [agentData.id])
    
    // Check for new inbox items
    const newInbox = tasks?.filter(t => 
      t.status === 'inbox' && 
      new Date(t.created_at) > new Date(lastCheck)
    ) || []
    
    // Check for new comments
    const taskIds = tasks?.map(t => t.id) || []
    let newComments = []
    
    if (taskIds.length > 0) {
      const { data: comments } = await supabase
        .from('mc_comments')
        .select('*, tasks:task_id(title)')
        .in('task_id', taskIds)
        .gt('created_at', lastCheck)
        .order('created_at', { ascending: false })
      
      newComments = comments || []
    }
    
    // Output
    console.log('\nðŸ“¬ MISSION CONTROL CHECK\n')
    
    if (newInbox.length > 0) {
      console.log(`ðŸ†• NEW INBOX ITEMS (${newInbox.length}):`)
      newInbox.forEach(t => console.log(`   â€¢ ${decrypt(t.title)}`))
      console.log()
    }
    
    if (newComments.length > 0) {
      console.log(`ðŸ’¬ NEW COMMENTS (${newComments.length}):`)
      newComments.forEach(c => {
        const content = decrypt(c.content)
        const preview = content.substring(0, 60).replace(/\n/g, ' ')
        const taskTitle = c.tasks?.title ? decrypt(c.tasks.title) : 'Unknown'
        console.log(`   â€¢ [${taskTitle}] ${preview}${content.length > 60 ? '...' : ''}`)
      })
      console.log()
    }
    
    if (newInbox.length === 0 && newComments.length === 0) {
      console.log('âœ“ No new activity since last check')
      console.log(`  ${tasks?.length || 0} tasks assigned`)
      console.log()
    }
    
    // Update state
    state.lastMCCommentsCheck = now
    state.lastMCCheck = now
    fs.writeFileSync(STATE_FILE, JSON.stringify(state, null, 2))
  },

  async list({ type = 'tasks' }) {
    if (type === 'tasks') {
      const { data, error } = await supabase
        .from('mc_tasks')
        .select('*')
        .neq('status', 'done')
        .order('created_at', { ascending: false })
      
      if (error) throw error
      
      console.log('\nACTIVE TASKS:\n')
      data.forEach(task => {
        const title = decrypt(task.title)
        const desc = task.description ? decrypt(task.description) : null
        console.log(`[${task.status.toUpperCase()}] ${title}`)
        console.log(`  ID: ${task.id}`)
        if (desc) console.log(`  ${desc}`)
        console.log()
      })
    } else if (type === 'agents') {
      const { data, error } = await supabase
        .from('mc_agents')
        .select('*')
        .order('name')
      
      if (error) throw error
      
      console.log('\nAGENTS:\n')
      data.forEach(agent => {
        console.log(`${agent.emoji} ${agent.name} [${agent.status.toUpperCase()}]`)
        console.log(`  ${agent.role}`)
        if (agent.last_heartbeat) {
          const mins = Math.floor((Date.now() - new Date(agent.last_heartbeat).getTime()) / 60000)
          console.log(`  Last heartbeat: ${mins}m ago`)
        }
        console.log()
      })
    }
  }
}

async function logActivity(agentName, type, message, taskId = null) {
  let agentId = null
  if (agentName) {
    const { data } = await supabase
      .from('mc_agents')
      .select('id')
      .eq('name', agentName)
      .single()
    agentId = data?.id
  }

  await supabase
    .from('mc_activities')
    .insert({
      agent_id: agentId,
      type,
      message,
      task_id: taskId
    })
}

// Parse command line arguments
const args = process.argv.slice(2)
const command = args[0]

if (!command || !commands[command]) {
  console.log(`
Command CLI

Usage:
  mc heartbeat --agent <name>
  mc status --agent <name> --status <idle|active|blocked> [--task <title>]
  mc task create --title <title> [--description <desc>] [--assign <agent>] [--tags <tag1,tag2>]
  mc task update --id <uuid> [--status <status>] [--title <title>] [--assign <agent>]
  mc comment --task <title|id> --agent <name> --message <text>
  mc check [--agent <name>]
  mc list [--type <tasks|agents>]

Examples:
  mc heartbeat --agent Clyde
  mc status --agent Clyde --status active --task "Building Command"
  mc task create --title "Fix Bonnie heartbeat" --assign Bonnie --tags bug,urgent
  mc task update --id abc123 --status done
  mc comment --task "Fix Bonnie heartbeat" --agent Clyde --message "Looking into it"
  mc check
  mc list --type tasks
`)
  process.exit(1)
}

// Parse options
const options = {}
for (let i = 1; i < args.length; i += 2) {
  const key = args[i].replace(/^--/, '')
  const value = args[i + 1]
  options[key] = value
}

// Execute command
commands[command](options)
  .catch(err => {
    console.error('Error:', err.message)
    process.exit(1)
  })
